//
// Copyright 2017 Maxime Daisy @ http://dooxe-creative.net/
//
// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the "Software"), to deal
// in the Software without restriction, including without limitation the rights
// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
// copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:
//
// The above copyright notice and this permission notice shall be included in
// all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
// THE SOFTWARE.
//

"use strict";var __extends=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),HTMLAudio;"undefined"!=typeof Audio&&(HTMLAudio=Audio);var jecho;!function(e){var t=new AudioContext;e.drivers={get UNBUFFERED(){return"unbuffered"},get BUFFERED(){return"buffered"}},e.events={get LOAD(){return"load"},get LOAD_PROGRESS(){return"loadprogress"},get PAN_CHANGED(){return"panchanged"},get PITCH_CHANGED(){return"pitchchanged"},get VOLUME_CHANGED(){return"volumechanged"},get POSITION_CHANGED(){return"positionchanged"},get DURATION_AVAILABLE(){return"durationavailable"}},e.load=function(e){return(new u).load(e)},e.formatTime=function(e,t){void 0===t&&(t="m:s");var r=Math.floor(e),n=Math.floor(r/60),i=Math.floor(n/60),o=i.toString();i<10&&(o="0"+o);var s=(n-=60*i).toString();n<10&&(s="0"+s);var u=(r-=60*n+60*i*60).toString();return r<10&&(u="0"+u),t.replace("h",o).replace("m",s).replace("s",u)};var r=function(){function e(e){this._source=e,this._listeners={}}return e.prototype.on=function(e,t){this._listeners[e]||(this._listeners[e]=[]),this._listeners[e].push(t)},e.prototype.dispatch=function(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];var n=this._listeners[e];if(n)for(var i=0,o=n;i<o.length;i++)o[i].apply(this._source,t)},e}(),n=function(){function t(){}return t.prototype.filter=function(e,t,r,n){},t.createZ=function(e){void 0===e&&(e=function(e,t,r){});var t=[0,0],r=[[],[]],n=[[],[]];return{filter:function(i,o,s,u){for(var a=0;a<u;++a){var c=t[i],p=(r[i][c]=o[a],n[i][c]=e(r[i],n[i],c));s[a]=p,t[i]++}}}},t.create=function(e){return{filter:function(e,t,r,n){}}},t.prototype.createLowPass=function(t){return e.AudioFilter.createZ(function(e,r,n){var i=e[n];return n>0&&(i=r[n-1]+t*(e[n]-r[n-1])),i})},t}();e.AudioFilter=n;var i=function(r){function n(){var e=r.call(this)||this,n=e;e._filters=[],e._gain=t.createGain(),e._analyser=t.createAnalyser(),e._spectrumSize=e._analyser.frequencyBinCount,e._waveformSize=e._analyser.frequencyBinCount,e._spectrum=new Uint8Array(e._spectrumSize),e._waveform=new Uint8Array(e._waveformSize),e._pannerNode=t.createStereoPanner(),e._scriptNode=t.createScriptProcessor(16384,1,1),e._pannerNode.connect(e._scriptNode),e._scriptNode.connect(e._analyser),e._scriptNode.connect(e._gain),e._gain.connect(t.destination);return e._scriptProcessorListener=function(e){for(var t=e.inputBuffer,r=e.outputBuffer,i=0;i<r.numberOfChannels;i++){for(var o=t.getChannelData(i),s=r.getChannelData(i),u=0;u<t.length;u++)s[u]=o[u];for(var a=0;a<n._filters.length;++a)n._filters[a].filter(i,o,s,t.length)}},e}return __extends(n,r),Object.defineProperty(n.prototype,"outputNode",{get:function(){return this._scriptNode},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"fftSize",{get:function(){return this._analyser.fftSize},set:function(e){if(e<32||e>32768)throw new Error;if(!(0!=e&&0==(e&e-1)))throw new Error("jecho: Audio.fftSize must be a power of 2");this._analyser.fftSize=e,this._spectrum=new Uint8Array(this._analyser.frequencyBinCount),this._waveform=new Uint8Array(this._analyser.frequencyBinCount)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"volume",{get:function(){return this._gain.gain.value},set:function(t){this._gain.gain.value=t,this.signals.dispatch(e.events.VOLUME_CHANGED,t)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"pan",{get:function(){return this._pannerNode.pan.value},set:function(t){this._pannerNode.pan.value=t,this.signals.dispatch(e.events.PAN_CHANGED,t)},enumerable:!0,configurable:!0}),n.prototype.onPlay=function(){this._scriptNode.addEventListener("audioprocess",this._scriptProcessorListener,!1)},n.prototype.onPause=function(){this._scriptNode.removeEventListener("audioprocess",this._scriptProcessorListener)},Object.defineProperty(n.prototype,"spectrum",{get:function(){return this._analyser.getByteFrequencyData(this._spectrum),this._spectrum},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"waveform",{get:function(){return this._analyser.getByteTimeDomainData(this._waveform),this._waveform},enumerable:!0,configurable:!0}),n.prototype.addFilter=function(e){-1==this._filters.indexOf(e)&&this._filters.push(e)},n.prototype.removeFilter=function(e){var t=this._filters.indexOf(e);-1!=t&&this._filters.splice(t,1)},n}(function(){function e(){this._signals=new r(this)}return Object.defineProperty(e.prototype,"signals",{get:function(){return this._signals},enumerable:!0,configurable:!0}),e.prototype.on=function(e,t){this.signals.on(e,t)},e}()),o=function(r){function n(){var e=r.call(this)||this;return e._currentTime=0,e._audio=new HTMLAudio,e._audioSource=t.createMediaElementSource(e._audio),e._audioSource.connect(e.outputNode),e._audio.addEventListener("timeupdate",function(e){},!1),e}return __extends(n,r),Object.defineProperty(n.prototype,"loop",{get:function(){return this._audio.loop},set:function(e){this._audio.loop=e},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"position",{get:function(){return this._audio.currentTime/this._audio.duration},set:function(t){this._audio.currentTime=t*this._audio.duration,this.signals.dispatch(e.events.POSITION_CHANGED,t)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"pitch",{get:function(){return this._audio.playbackRate},set:function(t){this._audio.playbackRate=t,this.signals.dispatch(e.events.PITCH_CHANGED,t)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"duration",{get:function(){return this._audio.duration},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isPlaying",{get:function(){return!this._audio.paused},enumerable:!0,configurable:!0}),n.prototype.play=function(){this._audio.currentTime=this._currentTime,this._audio.play(),this.onPlay()},n.prototype.pause=function(){this._currentTime=this._audio.currentTime,this._audio.pause(),this.onPause()},n.prototype.stop=function(){this._currentTime=0,this._audio.pause(),this.onPause()},n.prototype.load=function(t,r){var n=this;return new Promise(function(i,o){n._audio.addEventListener("canplay",function(){n.signals.dispatch(e.events.DURATION_AVAILABLE,n.duration),i(t)},!1),n._audio.addEventListener("error",function(e){o(e)},!1),n._audio.src=r,n._audio.load()})},n}(i),s=function(r){function n(){var e=r.call(this)||this;return e._buffer=null,e._source=null,e._pitch=1,e._interval=null,e._isPlaying=!1,e._position=0,e._timestamp=0,e._loop=!1,e}return __extends(n,r),n.prototype.time=function(){return Date.now()},n.prototype.getCurrentPosition=function(){var e=this.time()-this._timestamp,t=1e3*this._buffer.duration;return(e/=this._pitch)/t},Object.defineProperty(n.prototype,"loop",{get:function(){return this._source?this._source.loop:this._loop},set:function(e){this._source&&(this._source.loop=e),this._loop=e},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"position",{get:function(){return this.getCurrentPosition()},set:function(e){this.pause(),this._position=e,this.play()},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"pitch",{get:function(){return this._pitch},set:function(t){var r=this.isPlaying;r&&this.pause(),this._pitch=t,this._source&&(this._source.playbackRate.value=t),r&&this.play(),this.signals.dispatch(e.events.PITCH_CHANGED,t)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"duration",{get:function(){return this._buffer?this._buffer.duration:0},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isPlaying",{get:function(){return this._isPlaying},enumerable:!0,configurable:!0}),n.prototype.play=function(){var r=this,n=this._source=t.createBufferSource();if(n.connect(this.outputNode),!r._buffer)throw new Error("No buffer loaded !");n.loop=this._loop,n.onended=function(){r.stop()},n.buffer=r._buffer,n.playbackRate.value=this._pitch,this._timestamp=this.time()-this._position*this._pitch*this._buffer.duration*1e3;var i=this._position*this._buffer.duration;n.start(0,i),r._interval&&window.clearInterval(r._interval),r._interval=window.setInterval(function(){var t=r.getCurrentPosition();r.signals.dispatch(e.events.POSITION_CHANGED,t),this._position=t},10),this._isPlaying=!0,this.onPlay()},n.prototype.pause=function(){this._interval&&window.clearInterval(this._interval),this._isPlaying=!1,this._source.stop(),this.onPause()},n.prototype.stop=function(){this._interval&&window.clearInterval(this._interval),this._position=0,this._isPlaying=!1,this._source.stop(),this.onPause()},n.prototype.load=function(r,n){var i=this;return new Promise(function(o,s){var u=new XMLHttpRequest;u.open("GET",n,!0),u.responseType="arraybuffer",u.addEventListener("progress",function(t){if(t.lengthComputable){var r=t.loaded/t.total;i.signals.dispatch(e.events.LOAD_PROGRESS,r)}},!1),u.addEventListener("load",function(){t.decodeAudioData(u.response,function(t){i._buffer=t,i.signals.dispatch("load"),i.signals.dispatch("canplay"),i.signals.dispatch(e.events.DURATION_AVAILABLE,i.duration),o(r)},function(e){i.signals.dispatch("loaderror",e)})},!1),u.send()})},n}(i),u=function(){function t(t){void 0===t&&(t=e.drivers.BUFFERED),this._position=0,this._pitch=1,this._volume=1,this._signals=new r(this),t===e.drivers.BUFFERED?this._driver=new o:this._driver=new s}return t.prototype.on=function(e,t){return this._driver.on(e,t),this},Object.defineProperty(t.prototype,"loop",{get:function(){return this._driver.loop},set:function(e){this._driver.loop=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"position",{get:function(){return this._driver.position},set:function(e){this._driver.position=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"pitch",{get:function(){return this._driver.pitch},set:function(e){if(e<0)throw new Error("jecho: Audio.pitch must be >= 0");this._driver.pitch=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"pan",{get:function(){return this._driver.pan},set:function(e){if(e<-1||e>1)throw new Error("jecho: Audio.pan must be between -1 (left) and 1 (right)");this._driver.pan=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"volume",{get:function(){return this._driver.volume},set:function(e){if(e<0||e>1)throw new Error("jecho: Audio.volume must be in [0,1]");this._driver.volume=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"fftSize",{get:function(){return this._driver.fftSize},set:function(e){this._driver.fftSize=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"duration",{get:function(){return this._driver.duration},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isPlaying",{get:function(){return this._driver.isPlaying},enumerable:!0,configurable:!0}),t.prototype.load=function(e){return void 0===e&&(e=null),this._driver.load(this,e)},t.load=function(t){return(new e.Audio).load(t)},t.prototype.play=function(){this.isPlaying||this._driver.play()},t.prototype.pause=function(){this.isPlaying&&this._driver.pause()},t.prototype.stop=function(){this._driver.stop()},Object.defineProperty(t.prototype,"spectrum",{get:function(){return this._driver.spectrum},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"waveform",{get:function(){return this._driver.waveform},enumerable:!0,configurable:!0}),t.prototype.addFilter=function(e){return this._driver.addFilter(e),this},t.prototype.removeFilter=function(e){return this._driver.removeFilter(e),this},t}();e.Audio=u}(jecho||(jecho={})),"undefined"!=typeof module&&module.exports&&(module.exports=jecho);